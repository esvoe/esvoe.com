var vue=new Vue({el:"#messages-page",data:{conversations:[],newConversation:!1,recipients:[],currentConversation:{user:[]},liveChatters:{chatterOne:[],chatterTwo:[],chatterThree:[]},messageBody:""},created:function(){this.subscribeToPrivateMessageChannel(current_username),this.getConversations()},methods:{notify:function(e,s,t){var a=noty({text:e,layout:"bottomLeft",type:"success",theme:"relax",timeout:1,animation:{open:"animated fadeIn",close:"animated fadeOut",easing:"swing",speed:500}})},subscribeToPrivateMessageChannel:function(e){console.log("subscribeed to private channer");var s=this;this.pusher=new Pusher(pusherConfig.PUSHER_KEY,{encrypted:!0,cluster:'eu'}),this.MessageChannel=this.pusher.subscribe(e+"-message-created"),this.MessageChannel.bind("App\\Events\\MessagePublished",function(e){e.message.user=e.sender,s.currentConversation.id==e.message.thread_id?(s.currentConversation.conversationMessages.push(e.message),setTimeout(function(){jQuery("time.timeago").timeago(),s.autoScroll(".coversations-thread")},100)):(indexes=$.map(s.conversations.data,function(s,t){return s.id==e.message.thread_id?t:void 0}),""!=indexes?(s.conversations.data[indexes[0]].unread=!0,s.conversations.data[indexes[0]].lastMessage=e.message):s.$http.post(base_url+"ajax/get-message/"+e.message.thread_id).then(function(e){console.log(e.data),s.conversations.data.unshift(e.data.data)}))})},getConversations:function(){this.$http.post(base_url+"ajax/get-messages").then(function(e){this.conversations=JSON.parse(e.body).data,console.log(this.conversations),this.showConversation(this.conversations.data[0])})},showConversation:function(e){e&&e.id!=this.currentConversation.id&&(e.unread=!1,this.$http.post(base_url+"ajax/get-conversation/"+e.id).then(function(s){this.currentConversation=JSON.parse(s.body).data,this.currentConversation.user=e.user,vm=this,setTimeout(function(){vm.autoScroll(".coversations-thread"),jQuery("time.timeago").timeago()},100)}))},postMessage:function(e){messageBody=this.messageBody,this.messageBody="",this.$http.post(base_url+"ajax/post-message/"+e.id,{message:messageBody}).then(function(e){e.status&&(this.currentConversation.conversationMessages.push(JSON.parse(e.body).data),vm=this,$("#messageReceipient").focus(),setTimeout(function(){jQuery("time.timeago").timeago(),vm.autoScroll(".coversations-thread")},100))})},postNewConversation:function(){this.$http.post(base_url+"ajax/create-message",{message:this.messageBody,recipients:this.recipients}).then(function(e){e.status&&(vm=this,newThread=JSON.parse(e.body).data,console.log(newThread),indexes=$.map(vm.conversations.data,function(e,s){return e.id==newThread.id?s:void 0}),""!=indexes?(vm.conversations.data[indexes[0]].unread=!0,vm.conversations.data[indexes[0]].lastMessage=newThread.lastMessage):vm.conversations.data.unshift(e.data.data),$("#messageReceipient").focus(),this.recipients=[],this.newConversation=!1,this.messageBody="",this.showConversation(vm.conversations.data[0]),setTimeout(function(){jQuery("time.timeago").timeago(),vm.autoScroll(".coversations-thread")},100))})},autoScroll:function(e){$(e).animate({scrollTop:$(e)[0].scrollHeight+600},2e3)},showNewConversation:function(){this.newConversation=!0,this.currentConversation={user:[]},$("#messageReceipient").focus(),vm=this,setTimeout(function(){vm.toggleUsersSelectize()},10)},toggleUsersSelectize:function(){vm=this;var e=$("#messageReceipient").selectize({valueField:"id",labelField:"name",searchField:"name",render:{option:function(e,s){return'<div class="media big-search-dropdown"><a class="media-left" href="#"><img src="'+e.avatar+'" alt="..."></a><div class="media-body"><h4 class="media-heading">'+s(e.name)+"</h4><p>"+e.username+"</p></div></div>"}},onChange:function(s){$('[name="user_tags"]').val(s);var t=e[0].selectize;vm.recipients=t.items},load:function(e,s){return e.length?void $.ajax({url:base_url+"api/v1/users",type:"GET",dataType:"json",data:{search:e},error:function(){s()},success:function(e){s(e.data)}}):s()}})}}});